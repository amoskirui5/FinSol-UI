import { CREATE_MEMBER_LOAN_APPLICATION, CREATE_MEMBER_LOAN_APPROVAL, CREATE_MEMBER_LOAN_DISBURSEMENT, CREATE_MEMBER_LOAN_STAGE, FETCH_LOAN_APPLICATION_BY_ID, FETCH_LOAN_APPROVAL_BY_ID, FETCH_LOAN_ELIGIBILITY, FETCH_MEMBER_LOAN_APPLICATION, REJECT_LOAN } from "../constants/apiEndpoints";
import axiosInstance from "../interceptors/globaInterceptor";
import { BaseResponseDTO } from "../types/BaseResponseDTO";
import { LoanApprovalRequest, LoanToMemberDisbursementRequest } from "../types/LoanTypesSettings/loanTypeTypes";
import { CreateLoanApplicationRequest, LoanApplicationByIdResponse, LoanApprovalByIdResponse, LoanElegibilityResponse, LoanStagingRequestDTO, PaginatedLoanApplicationList, MemberLoanBalanceResponse, LoanBalanceByIdResponse } from "../types/MemberLoan/memberLoanTypes";
import { PaginationOptions } from "../types/paginationTypes";

export const submitLoanApplication = async (data: CreateLoanApplicationRequest):Promise<BaseResponseDTO> => {
    const response = await axiosInstance.post(CREATE_MEMBER_LOAN_APPLICATION, data);
    return response.data;
  };
  
export const fetchLoanApplications = async (options: PaginationOptions): Promise<PaginatedLoanApplicationList> => {
  // Build params object conditionally
  const params: any = {};
  
  if (options.pageNumber !== undefined) {
    params.pageNumber = options.pageNumber;
  }
  
  if (options.pageSize !== undefined) {
    params.pageSize = options.pageSize;
  }
  
  // Only include search parameters if searchTerm is provided and not empty
  if (options.searchTerm && options.searchTerm.trim() !== '') {
    params.searchTerm = options.searchTerm;
    params.searchField = options.searchField;
  }
  
  if (options.sortBy) {
    params.sortBy = options.sortBy;
  }
  
  if (options.sortDescending !== undefined) {
    params.sortDescending = options.sortDescending;
  }

  const response = await axiosInstance.get(FETCH_MEMBER_LOAN_APPLICATION, {
      params,
  });
  return response.data;
};

export const fetchLoanEligibility = async (memberId: string, loanTypeId?: string): Promise<LoanElegibilityResponse> => {
  const url = loanTypeId 
    ? `${FETCH_LOAN_ELIGIBILITY}/${memberId}?loanTypeId=${loanTypeId}` 
    : `${FETCH_LOAN_ELIGIBILITY}/${memberId}`;

  const response = await axiosInstance.get(url);
  return response.data;
}

export const fetchLoanDetailsById = async (loanId: string): Promise<LoanApplicationByIdResponse>=>{
  const response = await axiosInstance.get(FETCH_LOAN_APPLICATION_BY_ID+ `/${loanId}`);
  return response.data;
}

export const submitLoanApproval = async (data: LoanApprovalRequest):Promise<BaseResponseDTO> => {
  const response = await axiosInstance.post(CREATE_MEMBER_LOAN_APPROVAL, data);
  return response.data;
};

export const submitLoanRejection = async (loanApplicationId: string, remarks?: string): Promise<BaseResponseDTO> => {
  const response = await axiosInstance.post(`${REJECT_LOAN}/${loanApplicationId}`, { remarks });
  return response.data;
};

export const submitLoanDisbursement = async (data: LoanToMemberDisbursementRequest):Promise<BaseResponseDTO> => {
  const response = await axiosInstance.post(CREATE_MEMBER_LOAN_DISBURSEMENT, data);
  return response.data;
};


export const fetchLoanApprovalDetailsById = async (loanId: string): Promise<LoanApprovalByIdResponse>=>{
  
  const response = await axiosInstance.get(FETCH_LOAN_APPROVAL_BY_ID+ `/${loanId}`);

  return response.data;
}

export const StageLoanDisbursement = async (data: LoanStagingRequestDTO): Promise<BaseResponseDTO> => {
  const response = await axiosInstance.post(CREATE_MEMBER_LOAN_STAGE, data);
  return response.data;
}

// Additional loan management functions for new endpoints
export const getMemberLoanBalance = async (memberId: string): Promise<MemberLoanBalanceResponse> => {
  const response = await axiosInstance.get(`${import.meta.env.VITE_API_BASE_URL}api/LoanManagement/member/${memberId}/balance`);
  return response.data;
}

export const getMemberLoanBalanceByNumber = async (memberNumber: string): Promise<MemberLoanBalanceResponse> => {
  const response = await axiosInstance.get(`${import.meta.env.VITE_API_BASE_URL}api/LoanManagement/member/balance/by-number/${memberNumber}`);
  return response.data;
}

export const getLoanBalanceById = async (loanId: string): Promise<LoanBalanceByIdResponse> => {
  const response = await axiosInstance.get(`${import.meta.env.VITE_API_BASE_URL}api/LoanManagement/balance/by-loan/${loanId}`);
  return response.data;
}

export const getMemberLoanBalanceAsAt = async (memberId: string, asAtDate: string): Promise<MemberLoanBalanceResponse> => {
  const response = await axiosInstance.get(`${import.meta.env.VITE_API_BASE_URL}api/LoanManagement/member/${memberId}/balance/as-at/${asAtDate}`);
  return response.data;
}